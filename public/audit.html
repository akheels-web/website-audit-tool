<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Results - Digital Vint</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h2>üöÄ Digital Vint</h2>
            </div>
            <nav>
                <a href="index.html" class="btn-secondary">New Audit</a>
            </nav>
        </div>
    </header>

    <!-- Results Section -->
    <section class="results-section">
        <div class="container">
            <div id="resultsContainer" class="results-container">
                <!-- Results will be dynamically inserted here -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Digital Vint. All rights reserved.</p>
            <p>
                <a href="https://digitalvint.com">Main Website</a> ‚Ä¢ 
                <a href="mailto:contact@digitalvint.com">Contact</a>
            </p>
        </div>
    </footer>

    <!-- Consultation Modal -->
    <div id="consultationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>üìû Book Your Free Consultation</h2>
            <p>Let's discuss how we can improve your website's performance and drive more conversions.</p>
            
            <form id="consultationForm" class="consultation-form">
                <div class="form-group">
                    <label for="consultName">Your Name *</label>
                    <input type="text" id="consultName" required class="input-field">
                </div>
                <div class="form-group">
                    <label for="consultEmail">Email Address *</label>
                    <input type="email" id="consultEmail" required class="input-field">
                </div>
                <div class="form-group">
                    <label for="consultPhone">Phone Number</label>
                    <input type="tel" id="consultPhone" class="input-field">
                </div>
                <div class="form-group">
                    <label for="consultMessage">What challenges are you facing?</label>
                    <textarea id="consultMessage" rows="4" class="input-field"></textarea>
                </div>
                <button type="submit" class="btn-primary btn-large">Schedule Free Consultation</button>
            </form>
        </div>
    </div>

    <!-- Custom Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>üìä Get Your Custom Detailed Report</h2>
            <p>Receive a comprehensive PDF report with in-depth analysis and step-by-step action plan.</p>
            
            <div class="report-features">
                <div class="report-feature">
                    <span class="feature-check">‚úì</span>
                    <span>Detailed technical SEO audit</span>
                </div>
                <div class="report-feature">
                    <span class="feature-check">‚úì</span>
                    <span>Competitor comparison analysis</span>
                </div>
                <div class="report-feature">
                    <span class="feature-check">‚úì</span>
                    <span>Prioritized action roadmap</span>
                </div>
                <div class="report-feature">
                    <span class="feature-check">‚úì</span>
                    <span>ROI projections for each fix</span>
                </div>
            </div>
            
            <form id="reportForm" class="consultation-form">
                <div class="form-group">
                    <label for="reportEmail">Email Address *</label>
                    <input type="email" id="reportEmail" required class="input-field">
                </div>
                <div class="form-group">
                    <label for="reportCompany">Company Name</label>
                    <input type="text" id="reportCompany" class="input-field">
                </div>
                <button type="submit" class="btn-primary btn-large">Get Custom Report (Free)</button>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Display results from localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const results = JSON.parse(localStorage.getItem('auditResults'));
            if (!results) {
                window.location.href = 'index.html';
                return;
            }
            displayResults(results);
            initializeModals();
            
            // Capture initial audit as a lead (send to backend)
            captureAuditLead(results);
        });

        // Capture the initial audit as a lead
        async function captureAuditLead(results) {
            try {
                console.log('Capturing initial audit lead...');
                
                const leadData = {
                    type: 'audit_completed',
                    name: results.name || 'Website Owner',
                    email: results.email,
                    auditResults: results
                };

                // Send to backend
                const response = await fetch('/api/lead-capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(leadData)
                });

                if (response.ok) {
                    console.log('Initial audit lead captured successfully');
                } else {
                    console.log('Could not capture initial lead (non-critical)');
                }
            } catch (error) {
                console.error('Lead capture error (non-critical):', error);
                // Don't show error to user - this is background process
            }
        }

        function displayResults(data) {
            const container = document.getElementById('resultsContainer');
            
            const html = `
                <div class="results-header">
                    <h1>Your Website Audit Results</h1>
                    <p class="analyzed-url">${data.url}</p>
                    <p class="analysis-date">Analyzed on ${new Date(data.timestamp).toLocaleDateString()}</p>
                </div>

                <div class="overall-score">
                    <div class="score-circle ${getScoreClass(data.overallScore)}">
                        <span class="score-number">${data.overallScore}</span>
                        <span class="score-label">/100</span>
                    </div>
                    <div class="score-description">
                        <h2>${getScoreText(data.overallScore)}</h2>
                        <p>${getScoreMessage(data.overallScore)}</p>
                    </div>
                </div>

                <!-- Smart CTA Banner (Based on Score) -->
                <div class="smart-cta-banner ${data.overallScore < 70 ? 'urgent' : 'standard'}">
                    <div class="cta-banner-content">
                        ${data.overallScore < 70 ? `
                            <h3>‚ö†Ô∏è Your Website Needs Immediate Attention</h3>
                            <p>Your score indicates critical issues affecting your business. Let our experts fix them fast.</p>
                        ` : `
                            <h3>üöÄ Good Start! Let's Make It Perfect</h3>
                            <p>Your website is on the right track. We can help you reach peak performance.</p>
                        `}
                    </div>
                    <button onclick="openConsultationModal()" class="btn-primary">Get Expert Help Now</button>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>‚ö° Performance</h3>
                        <div class="metric-score ${getScoreClass(data.performance)}">
                            ${data.performance}/100
                        </div>
                        <p>${getMetricMessage('performance', data.performance)}</p>
                    </div>
                    <div class="metric-card">
                        <h3>üéØ SEO</h3>
                        <div class="metric-score ${getScoreClass(data.seo)}">
                            ${data.seo}/100
                        </div>
                        <p>${getMetricMessage('seo', data.seo)}</p>
                    </div>
                    <div class="metric-card">
                        <h3>üì± Mobile</h3>
                        <div class="metric-score ${getScoreClass(data.mobile)}">
                            ${data.mobile}/100
                        </div>
                        <p>${getMetricMessage('mobile', data.mobile)}</p>
                    </div>
                    <div class="metric-card">
                        <h3>‚ôø Accessibility</h3>
                        <div class="metric-score ${getScoreClass(data.accessibility)}">
                            ${data.accessibility}/100
                        </div>
                        <p>${getMetricMessage('accessibility', data.accessibility)}</p>
                    </div>
                </div>

                <div class="recommendations-section">
                    <h2>üöÄ AI-Powered Recommendations</h2>
                    <div class="recommendations-list">
                        ${data.recommendations.map((rec, index) => `
                            <div class="recommendation-card">
                                <div class="recommendation-header">
                                    <span class="recommendation-number">${index + 1}</span>
                                    <h3>${rec.title}</h3>
                                    <span class="priority-badge priority-${rec.priority.toLowerCase()}">
                                        ${rec.priority}
                                    </span>
                                </div>
                                <p class="recommendation-description">${rec.description}</p>
                                <div class="recommendation-impact">
                                    <strong>Expected Impact:</strong> ${rec.impact}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Lead Conversion CTAs -->
                <div class="conversion-cta-section">
                    <h2>Ready to Transform Your Website?</h2>
                    <p class="cta-subtitle">Choose how you'd like us to help you implement these improvements</p>
                    
                    <div class="cta-cards-grid">
                        <!-- CTA Card 1: Book Consultation -->
                        <div class="cta-card featured">
                            <div class="cta-badge">Most Popular</div>
                            <div class="cta-icon">üìû</div>
                            <h3>Book Free Consultation</h3>
                            <p>30-minute strategy call with our experts to discuss your specific needs</p>
                            <ul class="cta-benefits">
                                <li>‚úì Personalized action plan</li>
                                <li>‚úì ROI projection</li>
                                <li>‚úì Timeline & budget estimate</li>
                            </ul>
                            <button onclick="openConsultationModal()" class="btn-primary btn-large">
                                Schedule Free Call
                            </button>
                        </div>

                        <!-- CTA Card 2: Fix My Website -->
                        <div class="cta-card">
                            <div class="cta-icon">üîß</div>
                            <h3>Fix My Website</h3>
                            <p>Let our team implement all recommended fixes for you</p>
                            <ul class="cta-benefits">
                                <li>‚úì Full implementation</li>
                                <li>‚úì 30-day guarantee</li>
                                <li>‚úì Ongoing support</li>
                            </ul>
                            <a href="https://digitalvint.com/services" class="btn-primary btn-large">
                                Get Quote
                            </a>
                        </div>

                        <!-- CTA Card 3: Custom Report -->
                        <div class="cta-card">
                            <div class="cta-icon">üìä</div>
                            <h3>Get Custom Report</h3>
                            <p>Detailed PDF report with competitive analysis and roadmap</p>
                            <ul class="cta-benefits">
                                <li>‚úì 20+ page analysis</li>
                                <li>‚úì Competitor insights</li>
                                <li>‚úì Step-by-step guide</li>
                            </ul>
                            <button onclick="openReportModal()" class="btn-primary btn-large">
                                Request Report (Free)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Trust Section -->
                <div class="trust-section">
                    <h3>Trusted by 200+ Businesses</h3>
                    <div class="trust-stats">
                        <div class="trust-stat">
                            <div class="stat-number">95%</div>
                            <div class="stat-label">Client Satisfaction</div>
                        </div>
                        <div class="trust-stat">
                            <div class="stat-number">2.5x</div>
                            <div class="stat-label">Avg. Traffic Increase</div>
                        </div>
                        <div class="trust-stat">
                            <div class="stat-number">60%</div>
                            <div class="stat-label">Faster Load Times</div>
                        </div>
                    </div>
                </div>

                <!-- Final CTA -->
                <div class="final-cta">
                    <h2>Don't Let These Issues Cost You Customers</h2>
                    <p>Every day you wait, your competitors are getting ahead. Let's fix this together.</p>
                    <div class="cta-buttons">
                        <button onclick="openConsultationModal()" class="btn-primary btn-large">
                            Talk to an Expert
                        </button>
                        <a href="index.html" class="btn-secondary btn-large">Analyze Another Site</a>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 50) return 'score-fair';
            return 'score-poor';
        }

        function getScoreText(score) {
            if (score >= 90) return 'üéâ Excellent!';
            if (score >= 70) return 'üëç Good';
            if (score >= 50) return '‚ö†Ô∏è Needs Improvement';
            return '‚ùå Critical Issues';
        }

        function getScoreMessage(score) {
            if (score >= 90) return 'Your website is in great shape! Minor optimizations can make it even better.';
            if (score >= 70) return 'Your website is performing well, but there\'s room for improvement.';
            if (score >= 50) return 'Your website has several issues that need attention.';
            return 'Your website has critical issues affecting performance and user experience.';
        }

        function getMetricMessage(metric, score) {
            const messages = {
                performance: {
                    high: 'Fast loading speed',
                    medium: 'Could be faster',
                    low: 'Slow loading times'
                },
                seo: {
                    high: 'Well optimized',
                    medium: 'Missing key elements',
                    low: 'Poor SEO setup'
                },
                mobile: {
                    high: 'Mobile-friendly',
                    medium: 'Some mobile issues',
                    low: 'Not mobile-optimized'
                },
                accessibility: {
                    high: 'Accessible to all',
                    medium: 'Accessibility gaps',
                    low: 'Major accessibility issues'
                }
            };
            
            const level = score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low';
            return messages[metric][level];
        }

        // Modal Functions
        function initializeModals() {
            const modals = document.querySelectorAll('.modal');
            const closeButtons = document.querySelectorAll('.modal-close');
            
            closeButtons.forEach(btn => {
                btn.onclick = function() {
                    this.closest('.modal').style.display = 'none';
                }
            });
            
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            }

            // Form submissions
            document.getElementById('consultationForm').addEventListener('submit', handleConsultationSubmit);
            document.getElementById('reportForm').addEventListener('submit', handleReportSubmit);
        }

        function openConsultationModal() {
            const results = JSON.parse(localStorage.getItem('auditResults'));
            document.getElementById('consultEmail').value = results.email || '';
            document.getElementById('consultName').value = results.name || '';
            document.getElementById('consultationModal').style.display = 'flex';
        }

        function openReportModal() {
            const results = JSON.parse(localStorage.getItem('auditResults'));
            document.getElementById('reportEmail').value = results.email || '';
            document.getElementById('reportModal').style.display = 'flex';
        }

        async function handleConsultationSubmit(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            const formData = {
                type: 'consultation',
                name: document.getElementById('consultName').value,
                email: document.getElementById('consultEmail').value,
                phone: document.getElementById('consultPhone').value,
                message: document.getElementById('consultMessage').value,
                auditResults: JSON.parse(localStorage.getItem('auditResults'))
            };

            try {
                // Save to database via API
                console.log('Submitting consultation request...');
                const response = await fetch('/api/lead-capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('Response data:', result);

                if (!response.ok) {
                    throw new Error(result.message || result.error || 'Failed to submit');
                }

                console.log('Lead captured successfully:', result);

                // Send email via EmailJS
                await sendEmailNotification(formData, 'consultation');

                alert('Thank you! We\'ll contact you within 24 hours to schedule your free consultation.');
                document.getElementById('consultationModal').style.display = 'none';
                e.target.reset();

            } catch (error) {
                console.error('Submission error:', error);
                alert(`Submission failed: ${error.message}\n\nPlease try again or email us directly at contact@digitalvint.com`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function handleReportSubmit(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            const formData = {
                type: 'report',
                name: document.getElementById('reportEmail').value.split('@')[0],
                email: document.getElementById('reportEmail').value,
                company: document.getElementById('reportCompany').value,
                auditResults: JSON.parse(localStorage.getItem('auditResults'))
            };

            try {
                // Save to database via API
                const response = await fetch('/api/lead-capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit');
                }

                const result = await response.json();
                console.log('Lead captured:', result);

                // Send email via EmailJS
                await sendEmailNotification(formData, 'report');

                alert('Great! We\'re generating your custom report. You\'ll receive it via email within 2 hours.');
                document.getElementById('reportModal').style.display = 'none';
                e.target.reset();

            } catch (error) {
                console.error('Submission error:', error);
                alert('Something went wrong. Please try again or email us directly at contact@digitalvint.com');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Trigger Make.com webhook directly (backup method)
        async function triggerMakeWebhook(formData) {
            // IMPORTANT: Leave this EMPTY to avoid CORS issues
            // Make.com will be called from backend instead
            const MAKE_WEBHOOK_URL = ''; 
            
            if (!MAKE_WEBHOOK_URL) {
                console.log('Using backend for Make.com webhook (recommended)');
                return;
            }

            try {
                const nameParts = (formData.name || 'Website User').trim().split(' ');
                const firstName = nameParts[0] || 'Website';
                const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : 'Lead';

                const makeData = {
                    first_name: firstName,
                    last_name: lastName,
                    email: formData.email,
                    phone: formData.phone || '',
                    company: formData.company || formData.auditResults?.url || 'Not Provided',
                    website: formData.auditResults?.url || '',
                    description: formData.message || `${formData.type} request from website audit tool`,
                    lead_source: 'Web Download',
                    lead_status: 'Attempted to Contact',
                    audit_details: `Audit Score: ${formData.auditResults?.overallScore || 'N/A'}/100
Type: ${formData.type}
Performance: ${formData.auditResults?.performance || 'N/A'}
SEO: ${formData.auditResults?.seo || 'N/A'}
Mobile: ${formData.auditResults?.mobile || 'N/A'}
Accessibility: ${formData.auditResults?.accessibility || 'N/A'}`
                };

                await fetch(MAKE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(makeData)
                });

                console.log('Make.com webhook triggered successfully');
            } catch (error) {
                console.error('Make.com webhook failed (non-critical):', error);
            }
        }

        // EmailJS Integration
        async function sendEmailNotification(formData, type) {
            // EmailJS configuration
            const EMAILJS_SERVICE_ID = 'YOUR_EMAILJS_SERVICE_ID';
            const EMAILJS_TEMPLATE_ID = type === 'consultation' ? 'YOUR_CONSULTATION_TEMPLATE_ID' : 'YOUR_REPORT_TEMPLATE_ID';
            const EMAILJS_PUBLIC_KEY = 'YOUR_EMAILJS_PUBLIC_KEY';

            // Skip if not configured
            if (EMAILJS_SERVICE_ID === 'YOUR_EMAILJS_SERVICE_ID') {
                console.log('EmailJS not configured, skipping email');
                return;
            }

            const templateParams = {
                to_email: formData.email,
                to_name: formData.name || 'there',
                from_name: 'Digital Vint',
                type: type,
                website_url: formData.auditResults?.url || 'N/A',
                audit_score: formData.auditResults?.overallScore || 'N/A',
                message: formData.message || '',
                phone: formData.phone || 'Not provided',
                company: formData.company || 'Not provided'
            };

            try {
                const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service_id: EMAILJS_SERVICE_ID,
                        template_id: EMAILJS_TEMPLATE_ID,
                        user_id: EMAILJS_PUBLIC_KEY,
                        template_params: templateParams
                    })
                });

                if (response.ok) {
                    console.log('Email sent successfully via EmailJS');
                } else {
                    console.error('EmailJS error:', await response.text());
                }
            } catch (error) {
                console.error('EmailJS failed:', error);
                // Don't throw - email is not critical for form submission
            }
        }
    </script>
</body>
</html>
